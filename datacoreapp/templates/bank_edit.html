{% extends "base.html" %}

{% load static %}

{% block additional_styles %}
    <link href="{% static 'select2/select2.min.css' %}" rel="stylesheet">
    <link href="{% static 'select2/select2-bootstrap4.min.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row" style="max-width: 500px;">
        {% for field in form %}
            <div class="form-group col-12" style="margin-top: 10px;">
            <label class="col-12" style="margin-bottom: 3px;">{{ field.label }}</label>
            {{ field }}
        </div>
        {% endfor %}
        
    </div>
</div>
 
{% endblock %}


{% block footer %}
    <div class="form-group col-12" style="margin-top: 10px;">
        <input id="btn-submit" type="submit" class="btn btn-primary" style="float: left;" value="{{arabic_action}}" />
    </div>
{% endblock %}

{% block additional_scripts %}
    <script src="{% static 'select2/select2.min.js' %}" type="text/javascript"></script>
    <script>
        function format(value) {
            if (!value.id) { return value.text; }
            return '<i class="' + value.text + '" style="font-size: 22px; padding-left: 10px;"></i>' + value.text;
        } 

        $(document).ready(function() {
            $('.icon-picker').select2({
                formatResult: format,
                formatSelection: format,
                templateResult: format,
                templateSelection: format,
                escapeMarkup: function(m) { return m; }
            });

            $('.icon-picker').val("{{ bank.icon_class }}");
            $('.icon-picker').trigger('change');
        });

		function addRow(tableID) {

			var table = document.getElementById(tableID);
            var rowCount = table.rows.length;
			var row = table.insertRow(rowCount);

			var cell1 = row.insertCell(0);
            cell1.innerHTML = '<input type="checkbox" name="chk" class="form-check"/>';
            var cell2 = row.insertCell(1);
            cell2.innerHTML = '<input type="text" name="txtename" class="form-control" onkeypress="validate_en(event)" autocomplete="off"/>';
            var cell3 = row.insertCell(2);
            cell3.innerHTML = '<input type="text" name="txtaname" class="form-control" onkeypress="validate_ar(event)" autocomplete="off"/>';
            var cell4 = row.insertCell(3);
            cell4.innerHTML = '<select name="type" class="form-select"><option value="String">نص</option><option value="Number">رقم</option><option value="Date">تاريخ</option><option value="Bool">حقيقة</option><option value="Array">لائحة</option><option value="Object">شيء</option></select>';
              
		}

		function deleteRow(tableID) {
			try {
			var table = document.getElementById(tableID);
			var rowCount = table.rows.length;

			for(var i=0; i<rowCount; i++) {
				var row = table.rows[i];
				var chkbox = row.cells[0].childNodes[0];
				if(null != chkbox && true == chkbox.checked) {
					if(rowCount <= 1) {
						alert("Cannot delete all the rows.");
						break;
					}
					table.deleteRow(i);
					rowCount--;
					i--;
				}


			}
			}catch(e) {
				alert(e);
			}
		}

        // AJAX for posting
        function create_post() {
            console.log("create post is working!") // sanity check
            jsonFields = [];
            var i = 0;
            $('table tr').each(function(){
                if(i==0){
                    i++;
                    return;
                }
                item = {
                    "english_name": $(this).find('input[name="txtename"]').val(),
                    "arabic_name" : $(this).find('input[name="txtaname"]').val(),
                    "date_type" : $(this).find('.form-select').val()
                }
                jsonFields.push(item);
            })

            $('#btn-submit').prop('disabled', true);
            $.ajax({
                url : "/banks/", // the endpoint
                type : "POST", // http method
                data : { 
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    action: '{{action}}',
                    english_name : $('#id_english_name').val(),
                    arabic_name : $('#id_arabic_name').val(),
                    icon_class: $('#icon-picker-icon_class').val(),
                    description: $('#id_description').val(),
                    data_fields: JSON.stringify(jsonFields, null, 2)
                }, // data sent with the post request

                // handle a successful response
                success : function(json) {
                    if(json['code'] == '0'){
                        document.getElementsByClassName('toast-header')[0].style = 'background-color: deepskyblue'
                        document.getElementsByClassName('me-auto')[0].innerHTML = 'نجاح';
                        setTimeout(function() {
                            document.location.href = "/banks";
                        }, 2000);
                    }else{
                        document.getElementsByClassName('toast-header')[0].style = 'background-color: lightcoral'
                        document.getElementsByClassName('me-auto')[0].innerHTML = 'خطأ';
                        $('#btn-submit').prop('disabled', false);
                    }
                    document.getElementsByClassName('toast-body')[0].innerHTML = json['message'];
                    const toast = new bootstrap.Toast(document.getElementById('liveToast'));
                    toast.show()
                },

                // handle a non-successful response
                error : function(xhr,errmsg,err) {
                    $('#btn-submit').prop('disabled', false);
                    document.getElementsByClassName('toast-body')[0].innerHTML = err;
                    const toast = new bootstrap.Toast(document.getElementById('liveToast'));
                    toast.show()
                    console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                }
            });
        };
	
    </script>
{% endblock %}
{% extends "base.html" %}
{% load static %}
{% load custom_tags %}
{% block additional_styles %}

<link href="{% static 'querybuilder/css/query-builder.default.min.css' %}" rel="stylesheet">
<link href="{% static 'querybuilder/css/query-builder.rtl.css' %}" rel="stylesheet">
<link href="{% static 'querybuilder/css/query-builder.overrides.css' %}" rel="stylesheet">
<link href="{% static 'tempus/css/tempus-dominus.min.css' %}" rel="stylesheet">
<link href="{% static 'select2/select2.min.css' %}" rel="stylesheet">
<link href="{% static 'select2/select2-bootstrap4.min.css' %}" rel="stylesheet">

<link rel="stylesheet" type="text/css" href="{% static 'devexpress/css/dx.common.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'devexpress/css/dx.light.css' %}" />

<link href="{% static 'css/d3-context-menu.css' %}" rel="stylesheet">
<link href="{% static 'css/advanced_search.css' %}" rel="stylesheet">

{% endblock %}

{% block content %}

<div class="accordion" id="accordionExample">
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingTwo">
      <button class="accordion-button collapsed" type="button" role="button" data-bs-toggle="collapse"
        data-bs-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo" style="color: #585858;">
        شروط البحث
      </button>
    </h2>
    <div id="collapseTwo" class="accordion-collapse collapse show" aria-labelledby="headingTwo">
      <div class="accordion-body">
        <div>
          <div style="display: flex;flex-direction: row; gap: 5px;height: 500px;">
            <div id="edges_list" style="width: 300px;background-color: #f8f9fa;padding: 10px;border: 1px solid #dfdfdf;border-radius: 5px;overflow: auto;">

            </div>
            <!-- <svg id="edges_filter_canvas"width="960" height="600"></svg> -->
            <div id="edges_filter_canvas" style="flex-grow: 1;flex-basis: 0;background-image: url({% static 'images/grid.png' %});padding: 10px;border: 1px solid #dfdfdf;border-radius: 5px;overflow: auto;"></div>
          </div>
          <div style="margin-top: 15px; display: flex; flex-direction: row-reverse;">
            <button id="btn-submit" class="btn btn-primary"><span class="bi-search pl10"></span>بحث</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingThree">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree"
        aria-expanded="false" aria-controls="collapseThree" style="color: #585858;">
        نتائج البحث <span id="summary" style="color: #585858;position: absolute;left: 60px;"></span>
      </button>
    </h2>
    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree">
      <div class="accordion-body" style="padding: 10px 0px 0px 0px;">
        <div id="div-nothing"
          style="margin-top: 10vh;margin-bottom: 10vh; display: flex;justify-content: center;align-items: center;flex-direction: column;">
          <img src="{% static 'images/no_result_found.png' %}" style="margin-right: -100px;width: 300px; " />
          <div style="font-size: small;margin-right: -100px; color: lightgray;">لا يوجد نتائج</div>
        </div>
        <div id="results-view" style="display: flex; flex-direction: column;">

        </div>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block additional_scripts %}
<script src="{% static 'querybuilder/js/query-builder.standalone.min.js' %}" type="text/javascript"></script>
<script src="{% static 'querybuilder/i18n/query-builder.ar.js' %}" type="text/javascript"></script>
<script src="{% static 'tempus/js/tempus-dominus.min.js' %}" type="text/javascript"></script>
<script src="{% static 'bootstrap/js/moment-with-locales.min.js' %}" type="text/javascript"></script>
<script src="{% static 'select2/select2.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/polyfill.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/exceljs.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/FileSaver.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/jquery.scrollTo.min.js' %}" type="text/javascript"></script>
<script src="{% static 'devexpress/js/dx.all.js' %}" type="text/javascript"></script>
<script src="{% static 'devexpress/js/localization/dx.messages.ar.js' %}" type="text/javascript"></script>
<script src="{% static 'js/d3.js' %}" type="text/javascript"></script>
<script src="{% static 'js/d3-context-menu.js' %}" type="text/javascript"></script>
<script src="{% static 'js/graph_search.js' %}" type="text/javascript"></script>
<script>

  data = JSON.parse('{{data}}'.replace(/&quot;/g, '"'));
  selected_edges_list = {}

  $(document).ready(function () {
    DevExpress.localization.locale('ar');
    update_selected_edges()
  });

  function get_edges_list_template(key, edge,from,to){
    return '<div id="card-' + edge.english_name + '" name="' + key + '" class="card selectable-card" style="margin-top: 3px;">' +
                '<div class="card-body" style="padding: 3px;display: flex; flex-direction: row;">' +
                    '<span style="background-color: #f8f9fa;color: black;border-radius: 5px;align-content: center;vertical-align: middle;align-items: center;display: inline-flex;height: 26px;padding-right: 9px;padding-left: 9px;margin-top: 3px;margin-left: 10px;margin-right: 5px;">' +
                        '<span style="margin-left: 5px;align-items: center;display: inline-flex;" class="' + edge.icon+ '"></span>' +
                        '<span class="card-title ellipsis" style="max-width: 150px;padding-top: 5px;">' + edge.arabic_name + '</span>' +
                    '</span>' +
                    '<span style="margin-left: 5px;align-items: center;display: inline-flex;" class="' + from.icon+ '"></span>' +
                    '<span class="card-title ellipsis" style="max-width: 150px;padding-top: 3px;">' + from.arabic_name + '</span>' +
                    '<span class="fa fa-arrow-left" style="align-items: center;display: inline-flex; margin-left: 5px; margin-right: 5px;"></span>' +
                    '<span style="margin-left: 5px;align-items: center;display: inline-flex;" class="' + to.icon+ '"></span>' +
                    '<span class="card-title ellipsis" style="max-width: 150px;padding-top: 3px;">' +to.arabic_name + '</span>' +
                    '<span role="button" style="background-color: #f8f9fa;color: #262626;border-radius: 30px;height: 22px;padding-right: 5px;margin-top: 5px;left: 6px;position: absolute;">' +
                        '<span style="margin-left: 5px;align-items: center;display: inline-flex;" class="fa fa-plus" onclick="select_edge(event)"></span>' +
                    '</span>' +
                '</div>' +
            '</div>'
  }

  function select_edge(event){
    edge_key = $(event.target).closest('.card').attr('name');
    selected_edges_list[edge_key] = data[edge_key];
    delete data[edge_key];
    update_selected_edges();
    graph = {nodes:[], links:[]}
    addedIds=[]
    Object.entries(selected_edges_list).forEach(([k, v]) => {
        from_node = data[v.from]
        to_node = data[v.to]
        if(!addedIds.includes(v.from)){
            graph.nodes.push(from_node)
            addedIds.push(v.from)
        }
        if(!addedIds.includes(v.to)){
            graph.nodes.push(to_node)
            addedIds.push(v.to)
        }
        if(!addedIds.includes(v.id)){
            v['source'] = v.from
            v['target'] = v.to
            graph.links.push(v)
            addedIds.push(v.id)
        }
    })
    $('#edges_filter_canvas').empty()

    var menu = [
	{
		title: 'Remove Node',
		action: function(elm, d, i) {
			
			// if (d.parent) {
			  
			//   // find child and remove it
			//   for (var ii = 0; ii < d.parent.children.length; ii++) {
			//     if (d.parent.children[ii].name === d.name) {
			//       d.parent.children.splice(ii, 1);
			//       break;
			//     }
			//   }
			// }
			
			update(d);
		}
	}];

    chart = ForceGraph(graph, {
        nodeId: d => d.id,
        nodeGroup: d => d.english_name,
        addNodeLabel : true,
        nodeTitle: d => `${d.arabic_name}`,
        nodeLabel: d => `${d.arabic_name}`,
        addNodeIcon: true,
        nodeIcon: d => `${d.icon}`,
        nodeMenu: menu,
        linkId: d => d.id,
        addLinkLabel : true,
        linkTitle: d => `${d.arabic_name}`,
        linkLabel: d => `${d.arabic_name}`,
        containerId: 'edges_filter_canvas',
        invalidation: null // a promise to stop the simulation when the cell is re-run
    })
  }

  function update_selected_edges(){
    $('#edges_list').empty()
    Object.entries(data).forEach(([k, v]) => {
        if (k.startsWith('edge_')){
            $('#edges_list').append(get_edges_list_template(k, v,data[v['from']],data[v['to']]))
        }
    })
  }

  function update_qbfilter_value_input(rule) {
    $('#' + rule.id).find('.form-control').each(function (el) {
      if (rule.__.operator.type == 'between' || rule.__.operator.type == 'not_between')
        $(this).css({ "width": "47%", "display": "inline-block" });
      if (rule.__.filter.type == 'datetime') {
        new tempusDominus.TempusDominus($(this)[0], dtp_locale);
        $(this).attr('readOnly', true)
      }
    });
  }

  function create_post() {
    console.log("create post is working!") // sanity check
    if (!$('#qbuilder1').queryBuilder('validate')) {
      showError('الرجاء التأكد من جميع الحقول');
      return;
    }

    rules = $('#qbuilder1').queryBuilder('getRules')
    $('#btn-submit').prop('disabled', true);

    showOverlay();

    $.ajax({
      url: "/advanced_search/", // the endpoint
      type: "POST", // http method
      data: {
        action: 'search',
        csrfmiddlewaretoken: '{{ csrf_token }}',
        source: $("#select_source").val(),
        rules: JSON.stringify(rules)
      }, // data sent with the post request

      success: function (response) {
        hideOverlay();
        $('#btn-submit').prop('disabled', false);
        $('#results-view').empty();
        if (response.constructor == Object && response['code'] == '1')
          showError(response['message']);
        else {
          json_result = JSON.parse(response.message)
          if (Object.keys(json_result['srouces']).length > 0) {
            $('#div-nothing').hide();
            $('#summary')[0].innerText = json_result['count'].toLocaleString('en-US') + ' نتيجة في أقل من ' + json_result['time'].toFixed(3) + ' ثانية'
            $('#summary').show();
            Object.entries(json_result['srouces']).forEach(([k, v]) => {
              buildDevexpressTables(k, v, '/advanced_search/', '{{ csrf_token }}', 'results-view', 'single', 20);
            });
          } else {
            $('#div-nothing').show();
            $('#summary').hide();
          }

          $('#collapseThree').collapse('show');
          $('#collapseThree').delay(400).queue(function () {
            $('body').scrollTo($('#collapseThree')[0].offsetTop - 150);
          });
        }
      },

      error: get_ajax_error_function()
    });
  };



</script>
{% endblock %}